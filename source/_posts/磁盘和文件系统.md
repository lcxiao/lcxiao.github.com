---
title: 磁盘和文件系统
categories: Linux
tags:
  - 磁盘
  - linux
  - 文件系统
  - ext4
abbrlink: 4063649202
date: 2020-05-06 13:22:01
---
## 机械硬盘物理参数
### 数据接口
硬盘按数据接口不同，大致分为`ATA`（又称`IDE`）和`SATA`以及`SCSI`和`SAS`。接口速度不是实际硬盘数据传输的速度，当前普通硬盘的实际数据传输速度一般不会超过300MB/s。
### ATA
全称Advanced Technology Attachment，是用传统的40-pin并口数据线连接主板与硬盘的，接口速度最大为133MB/s，因为并口线的抗干扰性太差，且排线占用空间较大，不利电脑内部散热，已逐渐被SATA所取代。
### SATA
全称Serial ATA，也就是使用串口的ATA接口，特点是抗干扰性强，对数据线的要求比ATA低很多，且支持热插拔等功能。SATA-II的接口速度为300MiB/s，而新的SATA-III标准可达到600MiB/s的传输速度。SATA的数据线也比ATA的细得多，有利于机箱内的空气流通，整理线材也比较方便。
### SCSI
全称Small Computer System Interface（小型机系统接口），经历多代的发展，从早期的SCSI-II，到当前的Ultra320 SCSI以及Fiber-Channel（光纤通道），接口型式也多种多样。SCSI硬盘广为工作站级个人电脑以及服务器所使用，因此会使用较为先进的技术，如碟片转速15000rpm的高转速，且资料传输时CPU占用率较低，但是单价也比相同容量的ATA及SATA硬盘更加昂贵。
### SAS
全称Serial Attached SCSI，是新一代的SCSI技术，可兼容SATA硬盘，都是采取序列式技术以获得更高的传输速度，可达到12Gb/s。此外也透过缩小连接线改善系统内部空间等。

此外，由于SAS硬盘可以与SATA硬盘共享同样的背板，因此在同一个SAS存储系统中，可以用SATA硬盘来取代部分昂贵的SAS硬盘，节省整体的存储成本。但SATA存储系统并不能连接SAS硬盘。
### FC
全称Fibre Channel（光纤通道接口），拥有此接口的硬盘在使用光纤联接时具有热插拔性、高速带宽（4Gb/s或10Gb/s）、远程连接等特点；内部传输速率也比普通硬盘更高。但其价格高昂，因此FC接口通常只用于高端服务器领域。
## 电源接口
3.5寸台式机硬盘：ATA接口的硬盘一般使用D形4针电源接口（俗称“大4pin”），由Molex公司设计并持有专利；SATA硬盘则使用SATA电源线。
![alt 4p](https://upload.wikimedia.org/wikipedia/commons/thumb/f/fc/ATX_PS_connectors.jpg/180px-ATX_PS_connectors.jpg)
2.5寸的笔记本电脑硬盘，可直接由数据口供电，不需要额外的电源接口。在插上外接的便携式硬盘盒之后，由计算机外部的USB接口提供电力来源，而单个USB接口供电约为4~5V 500mA，若移动硬盘盒用电需求较高，有时需要接上两个USB接口才能使用，否则，需要外接电源供电。但如今多数新型硬盘盒（使用2.5寸或以下硬盘）已可方便地使用单个USB口供电。
![alt](https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Cylinder_Head_Sector.svg/200px-Cylinder_Head_Sector.svg.png)
### 避免故障
硬盘碟片转速极快，与碟片的距离极小；因此硬盘内部是无尘状态，硬盘有过滤器过滤进入硬盘的空气。为了避免磁头碰撞碟片，厂商设计出各种保护方法；当前硬盘对于地震有很好的防护力（1990年代的一些硬盘，若在使用中碰到略大的地震，就很可能损坏），防摔能力也大幅进步，电源关闭及遇到较大震动时磁头会立刻移到安全区（近期的硬盘也开始防范突然断电的情况）；而许多笔记本电脑厂商也开发出各种笔记本电脑结构来加强硬盘的防摔性。但硬盘在通电时耐摔度会降低（旋转逆动性）、也只能温和的移动，许多人也已经养成在关闭硬盘后30秒至一分钟内、不会移动硬盘（及笔记本电脑）的习惯。
2010年后氦气封装技术量产，以往的硬盘填充介质为空气，不过容易受到空气影响，因此碟片之间距离要够才行，而氦气的密度比起空气小上许多，且氦气特色就是稳定，使用他来当介质，阻力和震动相对小，因此碟片之间的距离就能缩小，所以同样的空间下能够装下更多的碟片，采用氦气封装的好处除了容量变大外[4]，温度和耗电能够再降低，因此耐用度和稳定性能够再提升。

### 逻辑结构
操作系统对硬盘进行读写时需要用到文件系统把硬盘的扇区组合成簇，并创建文件和树形目录制度，使操作系统对其访问和查找变得容易，这是因为操作系统直接对数目众多的扇区进行寻址会十分麻烦。
### 尺寸
硬盘驱动器的尺寸和用途可分为：

* 0.85英寸，多用于手机等便携设备中，已无厂商生产。
* 1英寸（微型硬盘，MicroDrive），多用于数字相机（CF type II接口），已无厂商生产。
* 1.8英寸，多用于笔记本电脑及外置硬盘盒中，已无厂商生产。
* 2.5英寸，多用于笔记本电脑及外置硬盘盒中。采用2.5"硬盘的外置硬盘盒一般不需外接电源。
* 3.5英寸，多用于台式机中。采用3.5"硬盘的外置硬盘盒一般需要外接电源，因为耗电量超过USB的供电上限，一直到USB 3.0问世后获得解决。
* 5.25英寸，多为早期台式机使用，已无厂商生产。
* 10.5英寸。
* 14英寸，NEC DKU800。
### 容量
当前硬盘的容量有36GB、40GB、45GB、60GB、75GB、80GB、120GB、150GB、160GB、200GB、250GB、300GB、320GB、400GB、500GB、640GB、750GB、1TB、1.5TB、2TB、2.5TB、3TB、4TB、5TB、6TB、8TB、10TB、12TB、14TB等多种规格
### 转速
硬盘每分钟旋转的圈数，单位是rpm（每分钟的转动数），有4200rpm、5400rpm、5900rpm、7200rpm、10000rpm、15000rpm、18000rpm等几种规格。一般来讲转速愈高通常数据传输速率愈好，但同时噪音、耗电量和发热量也较高。
### 缓存
主要有2MB、8MB、16MB、32MB、64MB、128MB、256MB等规格。
### 平均寻道时间
单位是ms（毫秒），有5.2ms、8.5ms、8.9ms、12ms等规格。
### 内部传输速度
包括磁头把数据从盘片读入缓存的速度，以及磁头把数据从缓存写入盘片的速度。可用来评价硬盘的读写速度和整体性能.

`一般固态硬盘的输入电压在5V左右，偏差5%以内。一般功耗较低，2.5W左右，电流500mA，这样即使usb2.0接口也能采用。
`
### 传输速率
- SATA: 6gbps
- SAS: 6gbps
- USB: 480MB/s

## SSD
固态硬盘采用SATA、PCI Express、M.2、mSATA、SAS、U.2、ZIF、IDE、CF、CFast等接口。由于价格及存储空间与机械硬盘有巨大差距，固态硬盘无法取代机械式硬盘。
`损坏时不可挽救`
--- ---
## Linux的哲学思想： 一切皆文件
设备类型：
块文件（block）随机访问，数据交换单位是‘块’
字符（character）线性访问，数据交换单位是‘字符’
设备文件 FHS
/dev   
    关联至设备的驱动程序：设备的访问入口
    设备号：
`major`：主设备号，区分设备类型；用于表明设备所需的驱动程序
`minor`：此设备号，区分同种类型下的不同设备，特定设备的访问入口

`mknod` 命令:创建块类型和字符类型的特殊文件。
```
mknod [option]... NAME TYPE [major minor]
    -m MODE:创建后的设备文件的访问权限。
```
磁盘:分区机制
IDE /dev/hd[a-z]
SCSI,SATA,USB,SAS:/dev/sd[a-z]
引用设备的方式：
设备文件名、卷标、UUID

### MBR和GPT
#### `MBR` 
446bytes: bootloader
64bytes: 分区表，每16bytes标识一个分区，一共只能有4个分区
* 4主分区
* 3主1扩展 
主引导记录（Master Boot Record，缩写：MBR），又叫做主引导扇区，是电脑引导后访问硬盘时所必须要读取的首个扇区，主引导扇区记录着硬盘本身的相关消息以及硬盘各个分割的大小及位置消息，是数据消息的重要入口。如果它受到破坏，硬盘上的基本数据结构消息将会丢失，需要用繁琐的方式试探性的重建数据结构消息后才可能重新访问原先的数据，对于那些扇区为512位组的磁盘，MBR分割表不支持容量大于2.2TB（2.2×1012字节）的分割。

#### `GPT`
全局唯一标识分区表（GUID Partition Table，缩写：GPT）是一个实体硬盘的分区表的结构布局的标准。它是可扩展固件接口（EFI）标准（被Intel用于替代个人计算机的BIOS）的一部分。GPT分配64bits给逻辑块地址，因而使得最大分区大小在264-1个扇区成为了可能。对于每个扇区大小为512字节的磁盘，那意味着可以有9.4ZB（9.4 x 1021字节）或8 ZiB-512字节（9,444,732,965,739,290,426,880字节或 18,446,744,073,709,551,615（264-1）个扇区x 512（29）字节每扇区）。

##### fdisk
```
fdisk -l 
fdisk device
    n: new
    d: del
    t: modify
    w: save
    q: without save quit
    m: help
    p: print
```

显示内核已识别的所有分区:
```
root@testlab:~# cat /proc/partitions 
major minor  #blocks  name

   8       16   20971520 sdb
   8       17   20970479 sdb1
   8        0   20971520 sda
   8        1     748544 sda1
   8        2          1 sda2
   8        5   20219904 sda5
 252        0   19214336 dm-0
 252        1     999424 dm-1
 ```
 使内核重读分区
centOS5: `partprobe [device]`
centOS6,7: `partx -a [device]` (有时需要两次)
`parted`: GNU Parted 是创建和处理分区表的程序。GParted 是 GUI 前端。
`sfdisk`: Partition table manipulator for Linux
`cfdisk`: Curses based disk partition table manipulator for Linux
-- --
## 创建文件系统
### 磁盘格式化
格式化是指对磁盘或磁盘中的分区（partition）进行初始化的一种操作，这种操作通常会导致现有的磁盘或分区中所有的文件被清除。格式化通常分为`低级格式化`和`高级格式化`。如果没有特别指明，对硬盘的格式化通常是指`高级格式化`，而对软盘的格式化则通常同时包括这两者。

`低级格式化`被用于指代对磁盘进行划分柱面、磁道、扇区的操作。
`高级格式化`又称`逻辑格式化`，它是指根据用户选定的文件系统（如FAT12、FAT16、FAT32、exFAT、NTFS、EXT2、EXT3等），在磁盘的特定区域写入特定数据，以达到初始化磁盘或磁盘分区、清除原磁盘或磁盘分区中所有文件的一个操作。高级格式化包括对主引导记录中分区表相应区域的重写、根据用户选定的文件系统，在分区中划出一片用于存放文件分配表、目录表等用于文件管理的磁盘空间，以便用户使用该分区管理文件。

### inode
`inode`: (index node)是指在许多“类Unix文件系统”中的一种数据结构，用于描述 文件系统对象（包括文件、目录、设备文件、socket、管道, 等等）。每个inode保存了 文件系统对象数据 的属性和磁盘块位置。文件系统对象属性 包含了各种元数据（如：最后修改时间） ，也包含用户组（owner ）和权限数据。

文件系统创建（格式化）时，就把存储区域分为两大连续的存储区域。一个用来保存文件系统对象的元信息数据，这是由inode组成的表，每个inode默认是256字节或者128字节。另一个用来保存“文件系统对象”的内容数据，划分为512字节的扇区，以及由8个扇区组成的4K字节的块。块是读写时的基本单位。一个文件系统的inode的总数是固定的。这限制了该文件系统所能存储的文件系统对象的总数目。典型的实现下，所有inode占用了文件系统1%左右的存储容量。

##### POSIX inode
```
POSIX标准强制规范了文件系统的行为。每个“文件系统对象”必须具有：

以字节为单位表示的文件大小。
设备ID，标识容纳该文件的设备。
文件所有者的User ID。
文件的Group ID
文件的模式（mode），确定了文件的类型，以及它的所有者、它的group、其它用户访问此文件的权限。
额外的系统与用户标志（flag），用来保护该文件。
3个时间戳，记录了inode自身被修改（ctime, inode change time）、文件内容被修改（mtime, modification time）、最后一次访问（atime, access time）的时间。
1个链接数，表示有多少个硬链接指向此inode。
到文件系统存储位置的指针。通常是1K字节或者2K字节的存储容量为基本单位。
使用stat系统调用可以查询一个文件的inode号码及一些元信息。
```
### Linux 的硬链接与软链接

链接简单说实际上是一种文件共享的方式，是 POSIX 中的概念，主流文件系统都支持链接文件。
你可以将链接简单地理解为 Windows 中常见的快捷方式（或是 OS X 中的替身），Linux 中常用它来解决一些库版本的问题，通常也会将一些目录层次较深的文件链接到一个更易访问的目录中。在这些用途上，我们通常会使用到软链接（也称符号链接）。

从使用的角度讲，两者没有任何区别，都与正常的文件访问方式一样，支持读写，如果是可执行文件的话也可以直接执行。

1. 硬链接： 与普通文件没什么不同，inode 都指向同一个文件在硬盘中的区块
`有相同的inode,每增加一个硬链接，会使文件inode引用计数增加`
`ln src link`
2. 软链接： 保存了其代表的文件的绝对路径，是另外一种文件，在硬盘上有独立的区块，访问时替换自身路径。
`inode 不同，删除符号连接不影响源文件，但删除原文件会使符号链接无效，建立符号链接不影响文件inode引用计数`
设备文件： 存储数据指针的空间当中存储的是设备号（major，minor）；
bitmap index： 位图索引。
`ln -s src link`
### VFS：Virtual File System
- linux文件系统：ext2,ext3,ext4,xfs,relserfs,brfs
- 光盘：iso9660
- 网络文件系统：nfs,cifs
- 集群：gfs2,ocfs2
- 内核级分布：ceph
- windows：vfat,ntfs
- 伪文件：proc,sysfs,tmpfs,hugepagefs
- Unix：UFS,FFS,JFS
- 交换：SWAP
- 用户空间的分布式：mogliefs,moosefs,glusterfs

### journal 日志文件系统
日志系统：元数据`metadata`和数据`data`
日志文件系统（英语：Journaling file system）是一种文件系统在发生变化时，先把相关的信息写入一个被称为日志的区域，然后再把变化写入主文件系统的文件系统。在文件系统发生故障（如内核崩溃或突然停电）时，日志文件系统更容易保持一致性，并且可以较快恢复。

对文件系统进行修改时，需要进行很多操作。这些操作可能中途被打断，也就是说，这些操作不是“不可中断”(atomic)的。如果操作被打断，就可能造成文件系统出现不一致的状态。

`例如：删除文件时，先要从目录树中移除文件的标示，然后收回文件占用的空间。如果在这两步之间操作被打断，文件占用的空间就无法收回。文件系统认为它是被占用的，但实际上目录树中已经找不到使用它的文件了。`

在非日志文件系统中，要检查并修复类似的错误就必须对整个文件系统的数据结构进行检查。一般在挂载文件系统前，操作系统会检查它上次是否被成功卸载，如果没有，就会对其进行检查。如果文件系统很大或者I/O带宽有限，这个操作可能会花费很长时间。
为了避免这样的问题，日志文件系统分配了一个称为日志（journal）的区域来提前记录要对文件系统做的更改。在崩溃后，只要读取日志重新执行未完成的操作，文件系统就可以恢复一致。这种恢复是原子的，因为只存在几种情况：

- 不需要重新执行：这个事务被标记为已经完成
- 成功重新执行：根据日志，这个事务被重新执行
- 无法重新执行：这个事务会被撤销，就如同这个事务从来没有发生过
- 日志本身不完整：事务还没有被完全写入日志，它会被简单忽略
#### 日志的三个级别
- 回写
`在回写模式中，只有元数据被记录到日志中，数据会被直接写入主文件系统。这种模式能提供较好的性能，不过有较大的风险。例如：在增大文件时，数据还未写入就发生崩溃，那么文件系统恢复后，文件后面就可能出现垃圾数据。`
- 顺序
`在顺序模式中，只有元数据被记录到日志中，但在日志被标记为提交前，数据会被写入文件系统。在这种模式下，如果在增大文件时，数据还未写入就发生崩溃，那么在恢复时这个事务会被简单的撤销，文件保持原来的状态。`
- 数据  
```在数据模式中，元数据和文件内容都先被写入日志中，然后在提交到主文件系统。这提高了安全性，但损失性能，因为所有数据要写入两次[1]。在这种模式下，如果在增大文件时，发生崩溃，那么可能有两种情况：

- 日志完整：这时事务会被重新执行，修改会被提交到主文件系统
- 日志不完整：这时主文件系统还未被修改，只需要简单放弃这个事务
```

常见的日志文件系统
* JFS：IBM的 Journaled File System, 最早的日志文件系统[1]。
* Ext4/Ext3文件系统：由Ext2文件系统演化而成的日志文件系统，广泛用于Linux系统。
* XFS文件系统：广泛用于Linux系统，取代了Ext4。
* ReiserFS：用B+树作为数据结构的日志文件系统，在处理小文件时有较好的性能。
* Btrfs：用B树作为数据结构，被认为是下一代Linux文件系统[2]。
* NTFS：微软的NTFS也是日志文件系统，也是Windows下最常用的文件系统。
* HFS+：苹果公司发展的OS X操作系统下主要使用的文件系统。

### 文件系统管理工具
- 创建
```
mkfs -v -t fs-type device
ext系列专用 mke2fs
    -t {ext2、ext3、ext4}： 指明文件系统类型
    -b {1024 | 2048 | 4096}： 指明文件系统的块大小
    -L LABEL： 指明卷标
    -j： 创建有日志功能的文件系统ext3；
        mke2fs -j = mke2fs -t ext3 = mkfs.ext3
    -i 每多少字节创建inode
    -N 直接指明要给此文件系统创建inode的数量；
    -O [^]FEATURE: 以指定的特性创建目标文件系统，不加拖字符表示启用，加拖字符表示关闭特性；
    -m 指定为超级用户保留的文件系统块的百分比。这样可以避免碎片，并允许root拥有的守护程序，默认为5%。
```
- 检测和修复
```
fsck: 用于实现文件系统检测的工具；
因进程意外中止或者系统崩溃等原因导致定稿操作非正常终止时，可能会造成文件损坏；
此时，应该检测并修复文件系统；建议，离线进行（非挂载状态）；

e2fsck: 检测ext2/3/4 文件系统错误
e2fsck [option] device
    -y: 默认对所有问题自动回答yes；
    -f：及时文件系统处于clean状态，也check一遍；

fsck: check and repair a Linux filesystem
    -t: fslist 指定文件系统类型；
    -a: 自动修复文件系统，不询问任何问题（请谨慎使用此选项）。
    -r: 交互式修复；
```
- 查看属性
```
dumpe2fs ：显示ext系列文件系统的属性信息；
    dumpe2fs [-h] device
tune2fs:
    查看或者修改ext系列文件系统的某些属性。
    tune2fs [option] device
        -l 查看超级块信息
    修改：
        -j ext2升级为ext3，无损升级，有数据也可升级;
        -L LABEL: 修改卷标
        -m 修改预留块的百分比；
        -O [^] 开启或者关闭某种特性；
        -o [^]mount_options：开启或者关闭某种默认挂载选项；
            acl/^acl: 开启或者关闭acl
blkid: 查找/打印块设备属性
    -L: 查找使用此文件系统标签的设备；
    -k: 列出所有已知的文件系统/ RAID并退出;
```
- 调整文件系统特性
```
e2label - 更改ext2 / ext3 / ext4文件系统上的卷标
    查看：e2label device
    设定：e2label device LABEL
```
CentOS6 如何使用xfs文件系统：
联网的话：`yum install xfsprogs`

#### Swap 文件系统
linux 的交换分区必须使用独立的文件系统
且文件系统的system ID必须为82；
创建Swap设备：
```
mkswap [option] device
    -L LABEL: 指明卷标
    -f： 强制
```
windows无法识别Linux的文件系统；因此，存储设备需要在两=两种系统之间交叉使用时，应该使用fat32（vfat）；
`mkfs.vfat device`


练习1:

练习2:
